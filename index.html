<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Car Wash POS — Offline (Full)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{padding:18px;background:#f7f8fb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .menu-card{min-height:200px}
    .qty-input{width:72px}
    .invoice{background:#fff;border-radius:6px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    small.note{color:#666}
    .cursor-hand{cursor:pointer}
    .cart-row{display:flex;justify-content:space-between;align-items:center;padding:.35rem 0;border-bottom:1px solid #eee}
    .cart-row .desc{flex:1}
    .muted{color:#666}
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">Car Wash POS — Offline (Full)</h3>
        <small class="note">Connected to backend — data syncs with server. Falls back to local storage if server unavailable.</small>
      </div>
      <div class="text-end">
        <small class="note">Uploaded backend file (reference):</small><br/>
        <a href="file:///mnt/data/miniproject app.py" target="_blank">/mnt/data/miniproject app.py</a>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-7">
        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Services / Menu</h5>
            <div>
              <button id="btnManageServices" class="btn btn-sm btn-outline-secondary">Manage</button>
              <button id="btnAddServiceQuick" class="btn btn-sm btn-outline-primary">Add Quick</button>
            </div>
          </div>

          <div class="row gy-2" id="servicesList">
            <!-- services rendered here -->
          </div>

          <hr/>
          <div class="d-flex gap-2 mt-2">
            <button id="btnClearAll" class="btn btn-outline-danger btn-sm">Clear Selection</button>
            <button id="btnSeed" class="btn btn-sm btn-info">Seed Demo Data</button>
            <button id="btnExportAll" class="btn btn-sm btn-outline-secondary">Export JSON</button>
            <a id="btnExportExcel" class="btn btn-sm btn-outline-success" href="/export/all.xlsx">Export Excel</a>
            <button id="btnImportAll" class="btn btn-sm btn-outline-secondary">Import Data</button>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h5>Customer & Vehicle</h5>
          <div class="row g-2">
            <div class="col-md-5">
              <label class="form-label">Choose existing customer</label>
              <select id="custSelect" class="form-select"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Or new customer name</label>
              <input id="newCustName" class="form-control" placeholder="Walk-in name">
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone</label>
              <input id="custPhone" class="form-control" placeholder="optional">
            </div>

            <div class="col-md-4">
              <label class="form-label">Vehicle reg no</label>
              <input id="regNo" class="form-control" placeholder="e.g. MH12AB1234">
            </div>
            <div class="col-md-4">
              <label class="form-label">Model</label>
              <input id="model" class="form-control" placeholder="e.g. Swift">
            </div>
            <div class="col-md-4">
              <label class="form-label">Create appointment?</label>
              <select id="createAppt" class="form-select">
                <option value="no" selected>No (Sale only)</option>
                <option value="yes">Yes (also create appointment)</option>
              </select>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button id="btnConfirm" class="btn btn-success">Confirm & Pay</button>
            <button id="btnQuickCash" class="btn btn-primary">Quick Cash</button>
            <button id="btnClearCust" class="btn btn-outline-secondary">Clear Customer</button>
          </div>
          <div id="status" class="mt-2"></div>
        </div>

        <div class="card p-3 mb-3">
          <h5>Saved Sales</h5>
          <div class="mb-2"><input id="searchSale" class="form-control form-control-sm" placeholder="Search sale id / customer / reg no"/></div>
          <div id="salesList" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="invoice mb-3">
          <h5>Invoice Preview</h5>
          <div id="invoiceBody" style="min-height:160px" class="mb-2"></div>
          <hr/>
          <div class="d-flex justify-content-between"><div>Subtotal</div><div id="subtotal">₹0</div></div>
          <div class="d-flex justify-content-between mt-1"><div>GST %</div><div><input id="gstPct" class="form-control form-control-sm" style="width:100px;display:inline-block" value="0"> %</div></div>
          <div class="d-flex justify-content-between mt-2"><div><strong>Total</strong></div><div id="total"><strong>₹0</strong></div></div>

          <div class="mt-3 d-flex gap-2">
            <button id="btnPrintInvoice" class="btn btn-outline-primary btn-sm">Print Invoice</button>
            <button id="btnCopyInvoice" class="btn btn-outline-secondary btn-sm">Copy Text</button>
            <button id="btnClearCart" class="btn btn-outline-danger btn-sm">Clear Cart</button>
          </div>
        </div>

        <div class="card p-3">
          <h6>Manage</h6>
          <div class="mb-2"><button id="openManageServices" class="btn btn-sm btn-outline-secondary">Open Services Manager</button></div>
          <div><small class="note">All data stored locally in browser under key <code>carwash_offline_v1</code>. You can export/import JSON.</small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Services Modal -->
  <div class="modal fade" id="manageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Manage Services</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div id="manageServicesList"></div>
      <hr/>
      <div class="row g-2">
        <div class="col"><input id="svcName" class="form-control" placeholder="Service name"></div>
        <div class="col-auto" style="max-width:130px"><input id="svcPrice" class="form-control" placeholder="Price"></div>
        <div class="col-auto"><button id="svcAddBtn" class="btn btn-primary">Add</button></div>
      </div>
    </div>
  </div></div></div>

  <input type="file" id="importFile" style="display:none" accept=".json" />

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // POS with backend integration — uses localStorage as cache/fallback
  const LS_KEY = 'carwash_offline_v1';
  const DEFAULT = { services:[], customers:[], vehicles:[], sales:[], appointments:[] };
  const API_BASE = ''; // Same origin

  function loadState(){ try{ const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(DEFAULT)); }catch(e){console.error(e); return JSON.parse(JSON.stringify(DEFAULT)); }}
  function saveState(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
  function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

  let state = loadState();
  let cart = []; // {service_id, qty}
  let backendAvailable = false;

  // Load data from backend
  async function loadFromBackend(){
    try{
      // Load services
      const svcRes = await fetch(`${API_BASE}/api/services`);
      if(svcRes.ok){
        const services = await svcRes.json();
        state.services = services;
        backendAvailable = true;
        saveState(state);
      }
      // Load customers
      const custRes = await fetch(`${API_BASE}/api/customers`);
      if(custRes.ok){
        const customers = await custRes.json();
        state.customers = customers;
        saveState(state);
      }
      // Load sales
      const salesRes = await fetch(`${API_BASE}/api/sales`);
      if(salesRes.ok){
        const sales = await salesRes.json();
        // Convert backend sales format to frontend format
        state.sales = sales.map(s => ({
          id: 's_' + s.id,
          customer_id: s.customer ? state.customers.find(c => c.name === s.customer)?.id : null,
          vehicle_id: s.reg_no ? state.vehicles.find(v => v.reg_no === s.reg_no)?.id : null,
          items: [], // Will be loaded from sale detail if needed
          total: s.total,
          timestamp: s.timestamp,
          method: 'cash'
        }));
        saveState(state);
      }
      showStatus('Data loaded from server', 'success');
    }catch(e){
      console.warn('Backend not available, using local data', e);
      backendAvailable = false;
      if(state.services.length === 0){
        // Fallback to default services if no local data
        state.services = [{id:1,name:'Exterior Wash',price:150},{id:2,name:'Full Wash + Interior',price:400},{id:3,name:'Polish & Wax',price:700}];
        saveState(state);
      }
    }
  }

  // Render services as selectable items (with + / - and qty input)
  const servicesList = document.getElementById('servicesList');
  function renderServices(){ servicesList.innerHTML=''; state.services.forEach(s=>{
    const div = document.createElement('div'); div.className='col-12 d-flex align-items-center justify-content-between';
    div.innerHTML = `<div><strong>${s.name}</strong><div class="muted">₹${s.price}</div></div>
      <div style="display:flex;gap:.5rem;align-items:center">
        <button class="btn btn-sm btn-light svc-minus" data-id="${s.id}">-</button>
        <input class="form-control form-control-sm qty-input" data-id="${s.id}" value="${getQty(s.id)}" style="width:64px;text-align:center">
        <button class="btn btn-sm btn-light svc-plus" data-id="${s.id}">+</button>
      </div>`;
    servicesList.appendChild(div);
  });
  // attach listeners
  document.querySelectorAll('.svc-plus').forEach(b=>b.addEventListener('click', e=>{ const id=e.target.dataset.id; changeQty(id, 1); }));
  document.querySelectorAll('.svc-minus').forEach(b=>b.addEventListener('click', e=>{ const id=e.target.dataset.id; changeQty(id, -1); }));
  document.querySelectorAll('.qty-input').forEach(i=>i.addEventListener('input', e=>{ const id=e.target.dataset.id; const v=Number(e.target.value)||0; setQty(id, v); }));
  renderInvoice(); renderCustSelect(); renderSalesList(); }

  function getQty(sid){ const it = cart.find(x=>String(x.service_id)===String(sid)); return it?it.qty:0; }
  function setQty(sid, qty){ qty = Math.max(0, Math.floor(qty||0)); const it = cart.find(x=>String(x.service_id)===String(sid)); if(it){ if(qty<=0) cart = cart.filter(x=>String(x.service_id)!==String(sid)); else it.qty = qty; } else { if(qty>0) cart.push({service_id: Number(sid), qty}); } saveState(state); renderInvoice(); }
  function changeQty(sid, delta){ const q = getQty(sid); setQty(sid, q+delta); document.querySelectorAll('.qty-input').forEach(i=>{ if(i.dataset.id===String(sid)) i.value = getQty(sid); }); }

  // Customers
  function renderCustSelect(){ const sel = document.getElementById('custSelect'); sel.innerHTML='<option value="">-- choose --</option>'; state.customers.forEach(c=> sel.innerHTML += `<option value="${c.id}">${c.name}${c.phone?(' • '+c.phone):''}</option>`); }

  // Invoice
  function calculate(){ const items = cart.map(ci=>{ const s = state.services.find(ss=>ss.id===ci.service_id); return {...s, qty:ci.qty, line: s.price*ci.qty}; }); const subtotal = items.reduce((a,b)=>a+b.line,0); const gstPct = Number(document.getElementById('gstPct').value||0); const tax = Math.round(subtotal*gstPct/100); const total = subtotal + tax; return {items, subtotal, tax, total}; }
  function renderInvoice(){ const out = calculate(); const body = document.getElementById('invoiceBody'); if(out.items.length===0) body.innerHTML='<p class="muted">No items selected.</p>'; else { body.innerHTML = '<div>' + out.items.map(it=>`<div class="cart-row"><div class="desc"><strong>${it.name}</strong><div class="muted">₹${it.price}</div></div><div style="width:120px;text-align:right">${it.qty} × ₹${it.price} = <strong>₹${it.line}</strong></div></div>`).join('') + '</div>'; } document.getElementById('subtotal').textContent = '₹' + out.subtotal.toFixed(0); document.getElementById('total').textContent = '₹' + out.total.toFixed(0); }

  document.getElementById('gstPct').addEventListener('input', renderInvoice);

  // Sales
  function renderSalesList(q=''){ const cont = document.getElementById('salesList'); cont.innerHTML=''; const qq = (q||document.getElementById('searchSale').value||'').toLowerCase(); const list = state.sales.filter(s=>{ if(!qq) return true; const cust = state.customers.find(c=>c.id===s.customer_id); const veh = state.vehicles.find(v=>v.id===s.vehicle_id); return s.id.toLowerCase().includes(qq) || (cust&&cust.name.toLowerCase().includes(qq)) || (veh&&veh.reg_no&&veh.reg_no.toLowerCase().includes(qq)); }); if(list.length===0) cont.innerHTML='<p class="muted">No sales</p>'; list.slice(0,200).forEach(s=>{ const cust = state.customers.find(c=>c.id===s.customer_id); const veh = state.vehicles.find(v=>v.id===s.vehicle_id); const el = document.createElement('div'); el.className='d-flex justify-content-between align-items-center border-bottom py-2'; el.innerHTML = `<div><strong>${cust?cust.name:'Walk-in'}</strong><div class="muted">${veh?veh.reg_no:''} • ${new Date(s.timestamp).toLocaleString()}</div></div><div><strong>₹${s.total.toFixed(0)}</strong><div class="mt-1"><button class="btn btn-sm btn-outline-primary me-1" onclick="printInvoice('${s.id}')">Invoice</button><button class="btn btn-sm btn-outline-secondary" onclick="deleteSale('${s.id}')">Delete</button></div></div>`; cont.appendChild(el); }); }
  document.getElementById('searchSale').addEventListener('input', ()=>renderSalesList());

  // Save sale
  async function saveSale(){ 
    const calc = calculate(); 
    if(calc.items.length===0) return showStatus('Select services','warning'); 
    
    let custId = document.getElementById('custSelect').value; 
    const newName = document.getElementById('newCustName').value.trim(); 
    const phone = document.getElementById('custPhone').value.trim(); 
    if(!custId && !newName) return showStatus('Select or add customer','warning'); 
    
    const reg = document.getElementById('regNo').value.trim(); 
    const model = document.getElementById('model').value.trim(); 
    const createAppt = document.getElementById('createAppt').value==='yes';
    
    // Prepare sale data
    const items = calc.items.map(it=>({ service_id: it.id, qty: it.qty }));
    const saleData = {
      customer: custId ? {id: parseInt(custId)} : {name: newName, phone: phone||null},
      vehicle: reg ? {reg_no: reg, model: model||null} : null,
      items: items,
      method: 'cash',
      create_appointment: createAppt
    };
    
    // Try to save to backend first
    if(backendAvailable){
      try{
        const res = await fetch(`${API_BASE}/api/sales`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(saleData)
        });
        if(res.ok){
          const result = await res.json();
          // Reload data from backend
          await loadFromBackend();
          cart=[]; 
          document.querySelectorAll('.qty-input').forEach(i=>i.value=0); 
          renderInvoice(); 
          renderCustSelect(); 
          renderSalesList();
          showStatus('Sale saved to server: #'+result.sale_id,'success');
          // Clear form
          document.getElementById('custSelect').value='';
          document.getElementById('newCustName').value='';
          document.getElementById('custPhone').value='';
          document.getElementById('regNo').value='';
          document.getElementById('model').value='';
          return;
        }
      }catch(e){
        console.warn('Backend save failed, saving locally', e);
      }
    }
    
    // Fallback to local storage
    if(!custId && newName){ 
      custId = uid('c'); 
      state.customers.push({id:custId, name:newName, phone}); 
    }
    let vehId = null; 
    if(reg){ 
      const v = state.vehicles.find(x=>x.reg_no.toLowerCase()===reg.toLowerCase()); 
      if(v) vehId = v.id; 
      else { 
        vehId = uid('v'); 
        state.vehicles.push({id:vehId, reg_no:reg, model:model, customer_id:custId}); 
      } 
    }
    const saleId = uid('s'); 
    const ts = new Date().toISOString(); 
    const saleItems = calc.items.map(it=>({ service_id: it.id, qty: it.qty, price: it.price, line: it.line })); 
    const sale = { 
      id: saleId, 
      customer_id: custId, 
      vehicle_id: vehId, 
      items: saleItems, 
      subtotal: calc.subtotal, 
      tax: calc.tax, 
      total: calc.total, 
      method: 'cash', 
      timestamp: ts, 
      create_appointment: createAppt 
    }; 
    state.sales.unshift(sale);
    if(sale.create_appointment){ 
      const svc = sale.items[0]; 
      const apptId = uid('a'); 
      state.appointments.push({id: apptId, sale_id: saleId, vehicle_id: vehId, service_id: svc.service_id, scheduled_at: ts, status:'done', paid:true}); 
    }
    saveState(state); 
    renderCustSelect(); 
    renderSalesList(); 
    cart=[]; 
    document.querySelectorAll('.qty-input').forEach(i=>i.value=0); 
    renderInvoice(); 
    showStatus('Sale saved locally: '+saleId,'info');
    
    // Clear form
    document.getElementById('custSelect').value='';
    document.getElementById('newCustName').value='';
    document.getElementById('custPhone').value='';
    document.getElementById('regNo').value='';
    document.getElementById('model').value='';
  }
  document.getElementById('btnConfirm').addEventListener('click', saveSale); document.getElementById('btnQuickCash').addEventListener('click', saveSale);

  // Print / Copy
  function printInvoice(saleId){ const s = state.sales.find(x=>x.id===saleId); if(!s) return alert('Sale not found'); const cust = state.customers.find(c=>c.id===s.customer_id); const veh = state.vehicles.find(v=>v.id===s.vehicle_id); let body = `<h2>Invoice</h2><p>Sale: ${s.id}</p><p>Date: ${new Date(s.timestamp).toLocaleString()}</p>`; body += `<p>Customer: ${cust?cust.name:'Walk-in'} ${cust&&cust.phone?('• '+cust.phone):''}</p>`; body += `<p>Vehicle: ${veh?veh.reg_no:'N/A'}</p>`; body += '<table style="width:100%;border-collapse:collapse" border="1"><thead><tr><th>Service</th><th>Qty</th><th>Price</th><th>Line</th></tr></thead><tbody>'; s.items.forEach(it=>{ const svc = state.services.find(ss=>ss.id===it.service_id); body += `<tr><td>${svc?svc.name:'?'}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">₹${it.price}</td><td style="text-align:right">₹${it.line}</td></tr>`; }); body += `</tbody><tfoot><tr><td colspan="3" style="text-align:right"><strong>Total</strong></td><td style="text-align:right">₹${s.total}</td></tr></tfoot></table>`; const win = window.open('','_blank','width=600,height=800'); win.document.write(`<html><head><title>Invoice ${s.id}</title></head><body>${body}<div style="margin-top:12px"><button onclick="window.print()">Print</button></div></body></html>`); win.document.close(); }
  document.getElementById('btnPrintInvoice').addEventListener('click', ()=>{ const calc = calculate(); const fake = { id: 'PREVIEW', timestamp: new Date().toISOString(), items: calc.items.map(li=>({service_id:li.id, qty:li.qty, price:li.price, line:li.line})), total: calc.total, customer_id: document.getElementById('custSelect').value || 'Walk-in' }; state.sales.unshift(fake); printInvoice(fake.id); state.sales.shift(); });
  document.getElementById('btnCopyInvoice').addEventListener('click', ()=>{ const calc = calculate(); let text='Invoice Preview\n\n'; calc.items.forEach(li=> text += `${li.qty}x ${li.name} — ₹${li.line}\n`); text += `\nSubtotal: ₹${calc.subtotal}\nTax: ₹${calc.tax}\nTotal: ₹${calc.total}\n`; navigator.clipboard?.writeText(text).then(()=>showStatus('Copied','success')).catch(()=>showStatus('Copy failed','danger')); });

  // Manage services modal logic
  const manageModal = new bootstrap.Modal(document.getElementById('manageModal'));
  document.getElementById('btnManageServices').addEventListener('click', ()=>{ renderManageServices(); manageModal.show(); });
  document.getElementById('openManageServices').addEventListener('click', ()=>{ renderManageServices(); manageModal.show(); });
  document.getElementById('btnAddServiceQuick').addEventListener('click', async ()=>{ 
    const name=prompt('Service name'); 
    if(!name) return; 
    const price=prompt('Price'); 
    if(!price) return; 
    
    if(backendAvailable){
      try{
        const res = await fetch(`${API_BASE}/api/services`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({name: name, price: Number(price)})
        });
        if(res.ok){
          await loadFromBackend();
          renderServices();
          showStatus('Service added to server', 'success');
          return;
        }
      }catch(e){
        console.warn('Backend add failed', e);
      }
    }
    
    // Fallback to local
    const id = state.services.length? Math.max(...state.services.map(s=>s.id))+1 : 1; 
    state.services.push({id, name, price: Number(price)}); 
    saveState(state); 
    renderServices(); 
  });
  function renderManageServices(){ const el = document.getElementById('manageServicesList'); el.innerHTML=''; state.services.forEach(s=>{ const row = document.createElement('div'); row.className='d-flex justify-content-between align-items-center mb-2'; row.innerHTML = `<div><strong>${s.name}</strong> — ₹${s.price}</div><div><button class="btn btn-sm btn-outline-secondary me-1" data-id="${s.id}" onclick="editSvc('${s.id}')">Edit</button><button class="btn btn-sm btn-outline-danger" data-id="${s.id}" onclick="delSvc('${s.id}')">Delete</button></div>`; el.appendChild(row); }); }
  window.editSvc = function(id){ const svc = state.services.find(x=>String(x.id)===String(id)); const nn = prompt('Name', svc.name); if(nn===null) return; const pp = prompt('Price', svc.price); if(pp===null) return; svc.name = nn; svc.price = Number(pp); saveState(state); renderServices(); renderManageServices(); }
  window.delSvc = function(id){ if(!confirm('Delete?')) return; state.services = state.services.filter(x=>String(x.id)!==String(id)); saveState(state); renderServices(); renderManageServices(); }
  document.getElementById('svcAddBtn').addEventListener('click', ()=>{ const name=document.getElementById('svcName').value.trim(); const price=Number(document.getElementById('svcPrice').value); if(!name||!price) return alert('Provide'); const id = state.services.length? Math.max(...state.services.map(s=>s.id))+1 : 1; state.services.push({id,name,price}); document.getElementById('svcName').value=''; document.getElementById('svcPrice').value=''; saveState(state); renderServices(); renderManageServices(); });

  // Export / Import
  document.getElementById('btnExportAll').addEventListener('click', ()=>{ const data=JSON.stringify(state,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='carwash_data_export.json'; a.click(); URL.revokeObjectURL(url); });
  document.getElementById('btnImportAll').addEventListener('click', ()=>document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change',(ev)=>{ const file=ev.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=(e)=>{ try{ const imp=JSON.parse(e.target.result); if(!imp.services||!imp.sales) return alert('Invalid'); state=imp; saveState(state); renderServices(); renderCustSelect(); renderSalesList(); showStatus('Imported','success'); }catch(err){ alert('Import failed'); } }; reader.readAsText(file); });

  // seed demo
  document.getElementById('btnSeed').addEventListener('click', ()=>{ if(state.customers.length===0){ const cid=uid('c'); state.customers.push({id:cid,name:'Demo Customer',phone:'9881556677'}); state.vehicles.push({id:uid('v'), reg_no:'MH12AB1111', model:'DemoCar', customer_id:cid}); } saveState(state); renderServices(); renderCustSelect(); renderSalesList(); showStatus('Demo seeded','info'); });

  // clear selection / cart
  document.getElementById('btnClearAll').addEventListener('click', ()=>{ cart=[]; document.querySelectorAll('.qty-input').forEach(i=>i.value=0); renderInvoice(); showStatus('Cleared','info'); });
  document.getElementById('btnClearCart').addEventListener('click', ()=>{ cart=[]; document.querySelectorAll('.qty-input').forEach(i=>i.value=0); renderInvoice(); showStatus('Cart cleared','info'); });
  document.getElementById('btnClearCust').addEventListener('click', ()=>{ document.getElementById('custSelect').value=''; document.getElementById('newCustName').value=''; document.getElementById('custPhone').value=''; document.getElementById('regNo').value=''; document.getElementById('model').value=''; showStatus('Customer cleared','info'); });

  // delete sale
  window.deleteSale = function(id){ if(!confirm('Delete sale '+id+'?')) return; state.sales = state.sales.filter(s=>s.id!==id); saveState(state); renderSalesList(); showStatus('Deleted','info'); }

  function showStatus(msg, type='info'){ const el=document.getElementById('status'); el.innerHTML=`<div class="alert alert-${type}">${msg}</div>`; setTimeout(()=>{ el.innerHTML=''; },3000); }

  function printInvoice(id){ printInvoice(id); }
  window.printInvoice = function(id){ const s = state.sales.find(x=>x.id===id); if(!s) return alert('Not found'); const cust = state.customers.find(c=>c.id===s.customer_id); const veh = state.vehicles.find(v=>v.id===s.vehicle_id); let body = `<h2>Invoice</h2><p>Sale: ${s.id}</p><p>Date: ${new Date(s.timestamp).toLocaleString()}</p>`; body += `<p>Customer: ${cust?cust.name:'Walk-in'} ${cust&&cust.phone?('• '+cust.phone):''}</p>`; body += `<p>Vehicle: ${veh?veh.reg_no:'N/A'}</p>`; body += '<table style="width:100%;border-collapse:collapse" border="1"><thead><tr><th>Service</th><th>Qty</th><th>Price</th><th>Line</th></tr></thead><tbody>'; s.items.forEach(it=>{ const svc=state.services.find(ss=>ss.id===it.service_id); body += `<tr><td>${svc?svc.name:'?'}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">₹${it.price}</td><td style="text-align:right">₹${it.line}</td></tr>`; }); body += `</tbody><tfoot><tr><td colspan="3" style="text-align:right"><strong>Total</strong></td><td style="text-align:right">₹${s.total}</td></tr></tfoot></table>`; const win=window.open('','_blank','width=700,height=800'); win.document.write(`<html><head><title>Invoice ${s.id}</title></head><body>${body}<div style="margin-top:12px"><button onclick="window.print()">Print</button></div></body></html>`); win.document.close(); }

  // helper functions
  function renderCustSelect(){ const sel=document.getElementById('custSelect'); sel.innerHTML='<option value="">-- choose --</option>'; state.customers.forEach(c=> sel.innerHTML += `<option value="${c.id}">${c.name}${c.phone?(' • '+c.phone):''}</option>`); }
  function renderSalesList(){ renderSalesList(); } // placeholder overwritten below
  function deleteSale(id){ }

  // initial render and helpers for outer scope
  function init(){ if(!localStorage.getItem(LS_KEY)){ saveState(state); } renderServices(); renderCustSelect(); renderSalesList(); }

  // override renderSalesList with correct implementation (declared earlier)
  function renderSalesList(){ const cont=document.getElementById('salesList'); cont.innerHTML=''; if(state.sales.length===0){ cont.innerHTML='<p class="muted">No sales yet</p>'; return; } state.sales.slice(0,200).forEach(s=>{ const cust=state.customers.find(c=>c.id===s.customer_id); const veh=state.vehicles.find(v=>v.id===s.vehicle_id); const el=document.createElement('div'); el.className='d-flex justify-content-between align-items-center border-bottom py-2'; el.innerHTML = `<div><strong>${cust?cust.name:'Walk-in'}</strong><div class='muted'>${veh?veh.reg_no:''} • ${new Date(s.timestamp).toLocaleString()}</div></div><div><strong>₹${s.total.toFixed(0)}</strong><div class='mt-1'><button class='btn btn-sm btn-outline-primary me-1' onclick="printInvoice('${s.id}')">Invoice</button><button class='btn btn-sm btn-outline-secondary' onclick="deleteSale('${s.id}')">Delete</button></div></div>`; cont.appendChild(el); }); }

  // deleteSale already defined earlier as window.deleteSale

  // search listener
  document.getElementById('searchSale').addEventListener('input', ()=>{ const q=document.getElementById('searchSale').value.toLowerCase(); const cont=document.getElementById('salesList'); cont.innerHTML=''; const list = state.sales.filter(s=>{ const cust=state.customers.find(c=>c.id===s.customer_id); const veh=state.vehicles.find(v=>v.id===s.vehicle_id); return !q || s.id.toLowerCase().includes(q) || (cust && cust.name.toLowerCase().includes(q)) || (veh && veh.reg_no && veh.reg_no.toLowerCase().includes(q)); }); if(list.length===0) cont.innerHTML='<p class="muted">No sales</p>'; list.slice(0,200).forEach(s=>{ const cust=state.customers.find(c=>c.id===s.customer_id); const veh=state.vehicles.find(v=>v.id===s.vehicle_id); const el=document.createElement('div'); el.className='d-flex justify-content-between align-items-center border-bottom py-2'; el.innerHTML = `<div><strong>${cust?cust.name:'Walk-in'}</strong><div class='muted'>${veh?veh.reg_no:''} • ${new Date(s.timestamp).toLocaleString()}</div></div><div><strong>₹${s.total.toFixed(0)}</strong><div class='mt-1'><button class='btn btn-sm btn-outline-primary me-1' onclick="printInvoice('${s.id}')">Invoice</button><button class='btn btn-sm btn-outline-secondary' onclick="deleteSale('${s.id}')">Delete</button></div></div>`; cont.appendChild(el); }); });

  // export/import logic already wired earlier

  // show status
  function showStatus(msg,type='info'){ const el=document.getElementById('status'); el.innerHTML = `<div class='alert alert-${type}'>${msg}</div>`; setTimeout(()=>el.innerHTML='',3000); }

  // start
  async function init(){
    if(!localStorage.getItem(LS_KEY)){ 
      saveState(state); 
    }
    await loadFromBackend();
    renderServices(); 
    renderCustSelect(); 
    renderSalesList(); 
  }
  init();
  </script>
</body>
</html>
